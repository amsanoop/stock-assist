{% extends "base.html" %}

{% block content %}
<div class="min-h-screen relative overflow-hidden bg-background">
  <div class="hero-glow hero-glow-1"></div>
  <div class="hero-glow hero-glow-2"></div>
  <div class="absolute inset-0 bg-[radial-gradient(circle_at_50%_-20%,#ffffff06,#00000000)]"></div>

  <div class="container mx-auto px-4 py-12 relative">
    <div class="bg-gray-800/80 rounded-2xl shadow-xl overflow-hidden border border-white/5 backdrop-blur-sm animate-fadeIn">
      <div class="px-8 py-6 border-b border-white/10">
        <h1 class="text-3xl font-bold text-white flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3 text-accent" viewBox="0 0 20 20" fill="currentColor">
            <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
          </svg>
          Your Referral Dashboard
        </h1>
        <p class="text-white/70 text-lg mt-2">
          Share StockAssist with friends and earn rewards! The more people you refer, the better rewards you unlock.
        </p>
      </div>

      <div class="p-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
          <!-- Referral Stats Card -->
          <div class="bg-gray-900/50 p-6 rounded-xl border border-white/5 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-accent/10 rounded-full -mr-16 -mt-16"></div>
            <h2 class="text-2xl font-bold text-white mb-6 relative z-10 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-accent" viewBox="0 0 20 20" fill="currentColor">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
              </svg>
              Your Referral Stats
            </h2>
            
            <div class="flex items-center mb-6 relative z-10">
              <div class="w-20 h-20 rounded-full bg-accent/20 flex items-center justify-center text-3xl font-bold text-white">
                {{ current_user.referral_count }}
              </div>
              <div class="ml-4">
                <p class="text-white/70">Total Referrals</p>
                <p class="text-xl font-semibold text-white">Level {{ current_user.referral_level }}</p>
              </div>
            </div>
            
            <div class="relative z-10">
              <h3 class="text-lg font-semibold text-white mb-2 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-accent" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" />
                </svg>
                Your Referral Link
              </h3>
              <div class="flex items-center">
                <input 
                  type="text" 
                  value="{{ referral_url }}" 
                  id="referralLink" 
                  readonly 
                  class="dark-input flex-grow mr-2"
                >
                <button 
                  onclick="copyReferralLink()" 
                  class="btn-accent px-4 py-2 whitespace-nowrap"
                >
                  Copy
                </button>
              </div>
              <p class="text-white/50 text-sm mt-2">
                Share this link with friends to earn rewards
              </p>
              
              <!-- Social Sharing Buttons -->
              <div class="mt-4">
                <h3 class="text-lg font-semibold text-white mb-2 flex items-center">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-accent" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" />
                  </svg>
                  Share via
                </h3>
                <div class="flex flex-wrap gap-2">
                  <button 
                    class="share-button p-2 bg-[#1DA1F2]/20 hover:bg-[#1DA1F2]/40 rounded-lg transition-colors" 
                    data-platform="twitter"
                    title="Share on Twitter"
                  >
                    <svg class="w-6 h-6 text-[#1DA1F2]" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path>
                    </svg>
                  </button>
                  <button 
                    class="share-button p-2 bg-[#1877F2]/20 hover:bg-[#1877F2]/40 rounded-lg transition-colors" 
                    data-platform="facebook"
                    title="Share on Facebook"
                  >
                    <svg class="w-6 h-6 text-[#1877F2]" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path fill-rule="evenodd" d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.988C18.343 21.128 22 16.991 22 12z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                  <button 
                    class="share-button p-2 bg-[#0A66C2]/20 hover:bg-[#0A66C2]/40 rounded-lg transition-colors" 
                    data-platform="linkedin"
                    title="Share on LinkedIn"
                  >
                    <svg class="w-6 h-6 text-[#0A66C2]" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path fill-rule="evenodd" d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                  <button 
                    class="share-button p-2 bg-[#25D366]/20 hover:bg-[#25D366]/40 rounded-lg transition-colors" 
                    data-platform="whatsapp"
                    title="Share on WhatsApp"
                  >
                    <svg class="w-6 h-6 text-[#25D366]" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path fill-rule="evenodd" d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                  <button 
                    class="share-button p-2 bg-gray-700/40 hover:bg-gray-700/60 rounded-lg transition-colors" 
                    data-platform="email"
                    title="Share via Email"
                  >
                    <svg class="w-6 h-6 text-gray-300" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path d="M1.5 8.67v8.58a3 3 0 003 3h15a3 3 0 003-3V8.67l-8.928 5.493a3 3 0 01-3.144 0L1.5 8.67z"></path>
                      <path d="M22.5 6.908V6.75a3 3 0 00-3-3h-15a3 3 0 00-3 3v.158l9.714 5.978a1.5 1.5 0 001.572 0L22.5 6.908z"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Referral Progress Card -->
          <div class="bg-gray-900/50 p-6 rounded-xl border border-white/5">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-accent" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
              </svg>
              Your Progress
            </h2>
            
            <div class="space-y-6">
              {% for reward in rewards %}
              <div class="relative">
                {% set progress = (current_user.referral_count / reward.required_referrals) * 100 if reward.required_referrals > 0 else 0 %}
                {% set progress = 100 if progress > 100 else progress %}
                
                <div class="flex justify-between mb-2">
                  <span class="text-white font-medium">Level {{ reward.level }}</span>
                  <span class="text-white/70">{{ current_user.referral_count }}/{{ reward.required_referrals }}</span>
                </div>
                
                <div class="h-3 bg-dark-300 rounded-full overflow-hidden">
                  <div 
                    class="h-full bg-accent rounded-full transition-all duration-1000" 
                    style="width: {{ progress }}%"
                  ></div>
                </div>
                
                <div class="mt-2 flex justify-between items-center">
                  <span class="text-white/70 text-sm">{{ reward.description }}</span>
                  
                  {% if current_user.can_claim_reward(reward.level) %}
                  <form action="{{ url_for('auth.claim_referral_reward', level=reward.level) }}" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button 
                      type="submit" 
                      class="btn-accent px-3 py-1 text-sm reward-button" 
                      data-level="{{ reward.level }}"
                    >
                      Claim Reward
                    </button>
                  </form>
                  {% elif current_user.referral_rewards_claimed and (reward.level|string) in current_user.referral_rewards_claimed %}
                  <span class="text-accent/80 text-sm">Claimed ✓</span>
                  {% else %}
                  <span class="text-white/40 text-sm">Locked</span>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Referrals List -->
        <div class="bg-gray-900/50 p-6 rounded-xl border border-white/5 mb-8">
          <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-accent" viewBox="0 0 20 20" fill="currentColor">
              <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
            </svg>
            Your Referrals
          </h2>
          
          {% if referrals %}
          <div class="overflow-x-auto rounded-xl border border-white/5">
            <table class="min-w-full divide-y divide-gray-700">
              <thead class="bg-gray-900/70">
                <tr>
                  <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-white/60 uppercase tracking-wider">
                    Name
                  </th>
                  <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-white/60 uppercase tracking-wider">
                    Joined
                  </th>
                  <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-white/60 uppercase tracking-wider">
                    Subscription
                  </th>
                </tr>
              </thead>
              <tbody class="bg-gray-800/50 backdrop-blur-sm divide-y divide-gray-700">
                {% for referral in referrals %}
                <tr class="hover:bg-gray-700/30 transition-colors duration-200">
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-white">
                    {{ referral.name }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-white/70">
                    {{ referral.created_at.strftime('%b %d, %Y') }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                      {% if referral.subscription.name == 'Free' %}
                        bg-gray-700 text-gray-300
                      {% elif referral.subscription.name == 'Starter' %}
                        bg-blue-900/60 text-blue-300 border border-blue-500/30
                      {% elif referral.subscription.name == 'Pro' %}
                        bg-purple-900/60 text-purple-300 border border-purple-500/30
                      {% else %}
                        bg-accent/20 text-accent
                      {% endif %}
                    ">
                      {{ referral.subscription.name }}
                    </span>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="bg-gray-900/50 p-8 rounded-xl text-center text-white/60 border border-white/5">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-white/20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <p class="text-lg">You haven't referred anyone yet</p>
            <p class="text-white/70 mt-2">Share your referral link to start earning rewards!</p>
          </div>
          {% endif %}
        </div>

        <!-- How It Works -->
        <div class="bg-gray-900/50 p-6 rounded-xl border border-white/5">
          <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-accent" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            How It Works
          </h2>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="p-4 bg-dark-300/50 rounded-lg border border-white/5">
              <div class="w-12 h-12 rounded-full bg-accent/20 flex items-center justify-center text-xl font-bold text-white mb-4">1</div>
              <h3 class="text-lg font-semibold text-white mb-2">Share Your Link</h3>
              <p class="text-white/70">Copy your unique referral link and share it with friends via email, social media, or messaging apps.</p>
            </div>
            
            <div class="p-4 bg-dark-300/50 rounded-lg border border-white/5">
              <div class="w-12 h-12 rounded-full bg-accent/20 flex items-center justify-center text-xl font-bold text-white mb-4">2</div>
              <h3 class="text-lg font-semibold text-white mb-2">Friends Sign Up</h3>
              <p class="text-white/70">When your friends click your link and create an account, they'll be automatically connected to you.</p>
            </div>
            
            <div class="p-4 bg-dark-300/50 rounded-lg border border-white/5">
              <div class="w-12 h-12 rounded-full bg-accent/20 flex items-center justify-center text-xl font-bold text-white mb-4">3</div>
              <h3 class="text-lg font-semibold text-white mb-2">Earn Rewards</h3>
              <p class="text-white/70">As your referral count grows, you'll unlock new reward levels with increasingly valuable benefits.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confetti Canvas -->
<canvas id="confetti-canvas" class="fixed inset-0 pointer-events-none z-50 hidden"></canvas>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script src="{{ url_for('static', filename='js/referrals.js') }}"></script>
{% endblock %} 